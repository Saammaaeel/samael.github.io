"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _toConsumableArray(t){if(Array.isArray(t)){for(var n=0,e=Array(t.length);n<t.length;n++)e[n]=t[n];return e}return Array.from(t)}!function(){var t="author",n="me",o='\n        <div class="typing-indicator">\n            <span class="typing-text">Ndut is typing</span>\n            <div class="typing-dots">\n                <div class="dot"></div>\n                <div class="dot"></div>\n                <div class="dot"></div>\n            </div>\n        </div>\n    ',i=null;function s(){i||(i=new(window.AudioContext||window.webkitAudioContext))}function a(t,n,o,r){i||s(),i&&(r=r||"sine",o=i.createOscillator(),n=i.createGain(),o.connect(n),n.connect(i.destination),o.frequency.setValueAtTime(t,i.currentTime),o.type=r,n.gain.setValueAtTime(.1,i.currentTime),n.gain.exponentialRampToValueAtTime(.01,i.currentTime+n/1e3),o.start(i.currentTime),o.stop(i.currentTime+n/1e3))}function r(){a(6e2,50,"sine")}function e(){a(800,150,"sine")}new Vue({el:"#mobile",data:{messages:[],dialogs:null,lastDialog:null,msgChain:Promise.resolve(),isTyping:!1,nextTopics:[],hasPrompt:!1,latestMsgContent:null},computed:{messageGroups:function(){for(var t=[],n=null,o=0;o<this.messages.length;o++){var i=this.messages[o];if(!n||n.author!==i.author||i.isTyping){var s={author:i.author,messages:[i],timestamp:i.timestamp};t.push(s),n=s}else n.messages.push(i),n.timestamp=i.timestamp}return t}}},mounted:function(){var t=this;$.getJSON("/anniv/assets/dialog.json",function(n){t.dialogs=n,t.nextTopics=t.dialogs.fromUser,t.appendDialog("0000")})},methods:{formatTimestamp:function(t){if(!t)return"";var n=new Date,o=new Date(t),i=n-o,s=Math.floor(i/6e4),a=Math.floor(i/36e5),u=Math.floor(i/864e5);return s<1?"now":s<60?s+"m ago":a<24?a+"h ago":u+"d ago"},appendDialog:function(n){var o=this;if("object"===_typeof(n)&&n.length>0)n.forEach(function(t){return o.appendDialog(t)});else{if(null!=n){this.isTyping=!0;var i=this.getDialog(n);return e(i.details).forEach(function(n){o.msgChain=o.msgChain.then(function(){return u(700)}).then(function(){return o.sendMsg(n,t)})}),i.nextAuthor?this.appendDialog(i.nextAuthor):this.msgChain.then(function(){o.lastDialog=i,o.isTyping=!1})}this.lastDialog.responses=null}},sendMsg:function(t,n){switch(n){case"me":return this.sendUserMsg(t);default:return this.sendFriendMsg(t,n)}},sendFriendMsg:function(i,s){var a=this,u=e(i),l=u.replace(/<[^>]+>/g,"").length,h=/<img[^>]+>/.test(u),c=l>2||h,f={author:s,content:c?o:u,isImg:h,isTyping:c,timestamp:new Date};return this.messages.push(f),c?(this.markMsgSize(f),setTimeout(p),function(t){var n=t<20?80:t<50?60:45;return Math.min(n*t+500*Math.random(),3e3)}(l),u(function(t){var n=t<20?80:t<50?60:45;return Math.min(n*t+500*Math.random(),3e3)}(l)).then(function(){return h?s.markMsgSize(f,a):s.typewriterEffect(f,u)}).then(function(){return u(150)}).then(function(){f.typewriterComplete||(f.content=u),f.isTyping=!1,d()})):(d(),Promise.resolve())},typewriterEffect:function(t,n){var o=this;return new Promise(function(i){var s=0,a=n.replace(/<[^>]+>/g,""),u=50;function e(){s<a.length?(s++,t.content=n.substring(0,s),t.typewriterComplete=!1,o.messages=[].concat(_toConsumableArray(o.messages)),3===s%3&&r(),setTimeout(e,u+30*Math.random())):(t.content=n,t.typewriterComplete=!0,i())}e()})},sendUserMsg:function(t){return this.messages.push({author:n,content:t,timestamp:new Date}),d(),Promise.resolve()},markMsgSize:function(t,n){var o=this,e=void 0===n?null:n;return this.latestMsgContent=e||t.content,u(0).then(function(){return t.isImg&&g($("#mock-msg img"))}).then(function(){o.messages=[].concat(_toConsumableArray(o.messages))})},getDialog:function(t){var n=this.dialogs.fromMe.filter(function(n){return n.id===t});return n?n[0]:null},getDialogFromUser:function(t){var n=this.dialogs.fromUser.filter(function(n){return n.id===t});return n?n[0]:null},togglePrompt:function(t){this.isTyping||(this.hasPrompt=t)},addReaction:function(t,n){t.reactions||(t.reactions=[]);var o=t.reactions.indexOf(n);o>-1?t.reactions.splice(o,1):t.reactions.push(n),this.messages=[].concat(_toConsumableArray(this.messages))},respond:function(t){return this.say(t.content,t.nextAuthor)},ask:function(t){var n=e(t.details);return this.say(n,t.nextAuthor)},say:function(t,e){var o=this;return this.hasPrompt=!1,u(200).then(function(){return o.sendMsg(t,n)}).then(function(){return u(300)}).then(function(){return o.appendDialog(e)})}}});function e(t){return"string"!=typeof t&&t.length?t[Math.floor(Math.random()*t.length)]:t}function d(){e(),setTimeout(function(){p();var t=$("#mobile-body-content .msg-row:last-child .msg");t.find("a").attr("target","_blank"),g(t).then(p)})}function p(){var t=$("#mobile-body-content"),n=t[0].scrollHeight-t.height()-t.scrollTop();if(!(Math.abs(n)<10)){var o=400,i=Date.now(),s=t.scrollTop(),a=function(t){return 1-Math.pow(1-t,3)},r=function e(){var c=Date.now()-i,u=Math.min(1,c/o),l=a(u);if(t.scrollTop(s+n*l),u<1)requestAnimationFrame(e)};requestAnimationFrame(r)}}function u(t){return new Promise(function(n){setTimeout(n,t||0)})}function g(t){return new Promise(function(n){t.one("load",n).each(function(t,n){n.complete&&$(n).trigger("load")})})}}();